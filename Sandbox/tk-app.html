<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<element name="tk-app" on-keyup="keyup">
  <template>
    <style>
      .bottom {
        position: absolute;
        height: 244px;
        right: 8px;
        bottom: 8px;
        left: 8px;
        overflow: auto;
      }
      .top {
        position: absolute;
        top: 0px;
        padding: 4px;
        right: 350px;
        left: 0px;
        height: 34px;
        background-color: white;
        overflow: hidden;
      }
      .left {
        position: absolute !important;
        top: 34px;
        right: 350px;
        bottom: 0;
        left: 0;
        background-color: white !important;
      }
      .right {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 350px;
        overflow: auto;
      }
      .left-inner {
        position: absolute !important;
        top: 0;
        width: 264px;
        bottom: 0;
        left: 0;
        background-color: white !important;
      }
      .middle-inner {
        position: absolute;
        top: 0px;
        right: 0;
        bottom: 0;
        left: 264px;
        background-color: white;
        overflow: hidden;
      }
      .fit {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      .app-selected {
        outline: dashed thin rgba(0, 98, 255, 0.4);
        outline-offset: 1px;
      }
      .tab-selected {
        z-index: 100;
      }
    </style>
    <g-tabs id="tabs" class="top" selected="{{selectedTab}}">
      <div name="design">Design</div>
      <div name="source">Source</div>
    </g-tabs>
    <div id="design" class="left">
      <g-sidebar class="left-inner" label="Palette">
      <tk-palette
          id="palette"
          class="fit"
          elements="{{elements}}"
          on-palette-drag-start="paletteDragStart"
          on-palette-drag="paletteDrag"
          on-palette-drag-end="paletteDragEnd">
      </tk-palette>
    </g-sidebar>
      <tk-canvas
        id="canvas"
        tabIndex="-1"
        on-tap="canvasTap"
        on-pointerup="canvasDrop"
        class="middle-inner">
      </tk-canvas>
    </div>
    <tk-source
      id="source"
      class="left"
      element="{{$.canvas}}">
    </tk-source>
    <tk-inspector
          id="inspector"
          class="right"
          element="{{selected}}"
          on-parent-element="selectParentAction"
          on-delete-element="deleteElement"
          on-property-changed="inspectorPropertyChanged">
    </tk-inspector>
  </template>
  <script>
    var metadata = document
      .querySelector('#components').content
      .querySelector('#metadata').content;

    Toolkit.register(this, {
      selected: null,
      selectedTab: 'design',
      ready: function() {
        this.elements = Array.prototype.slice.call(
            metadata.querySelectorAll('tk-meta'));
        this.selectedTabChanged();
      },
      selectedChanged: function(inOld) {
        classFollows(this.selected, inOld, 'app-selected');
        this.canvasChange();
      },
      inspectorPropertyChanged: function() {
        this.canvasChange();
      },
      canvasChange: function() {
        this.$.source.update();
      },
      createNew: function(tag) {
        var meta = metadata.querySelector('#' + tag);
        var neo = meta.createElement();
        neo.id = tag.split('-').pop().toLowerCase();
        neo.style.position = 'absolute';
        neo.meta = meta.properties;
        this.$.canvas.appendChild(neo);
        this.selected = neo;
        this.neo = neo;
      },
      paletteDragStart: function(event, detail) {
        var rect = this.getBoundingClientRect();
        this.origin = {
          x: rect.left + this.$.canvas.offsetLeft,
          y: rect.top + this.$.canvas.offsetTop
        };
        this.dragType = detail;
        this.createNew(detail);
      },
      paletteDrag: function(event, detail) {
        if (this.neo) {
          var x = detail.x - this.origin.x - 24;
          var y = detail.y - this.origin.y - 24;
          var p = this.$.canvas.snap(x, y);
          this.neo.style.left = p.x + 'px';
          this.neo.style.top = p.y + 'px';
        }
      },
      paletteDragEnd: function() {
        // if the drag ends before neo has dropped on canvas, remove him
        if (this.neo) {
          this.neo.parentNode.removeChild(this.neo);
          this.neo = null;
        }
      },
      canvasDrop: function(e) {
        // if dropped on canvas, let neo stay
        if (this.neo) {
          if (e.target != this.$.canvas) {
            this.neo.style.left = null;
            this.neo.style.top = null;
            this.neo.style.position = null;
          }
          e.target.appendChild(this.neo);
        }
        this.neo = null;
      },
      deleteElement: function() {
        var e = this.selected;
        if (e) {
          e.parentNode.removeChild(e);
          this.selected = null;
          this.canvasChange();
        }
      },
      canvasTap: function(event) {
        this.inspectTarget(event);
      },
      inspectTarget: function(event) {
        var t = event.target;
        if (t) {
          this.selected = (t === this.$.canvas ? null : t);
        }
      },
      selectParentAction: function() {
        var e = this.selected;
        if (e && e.parentNode) {
          e = e.parentNode;
          if (e === this.$.canvas) {
            e = null;
          }
          this.selected = e;
        }
      },
      selectedTabChanged: function(inOldValue) {
        classFollows(this.$[this.selectedTab], this.$[inOldValue], 
          'tab-selected');
      },
      keyup: function(event) {
        if (event.keyCode === 27) {
          this.selectParentAction();
        }
      }
    });
    function classFollows(anew, old, className) {
      if (old) {
        old.classList.remove(className);
      }
      if (anew) {
        anew.classList.add(className);
      }
    }
  </script>
</element>
