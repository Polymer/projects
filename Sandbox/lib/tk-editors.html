<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<element name="tk-abstract-editor" attributes="value">
  <script>
    Toolkit.register(this, {
      value: null,
      workingValue: null,
      valueChanged: function() {
        this.workingValue = this.value;
      },
      commit: function() {
        this.value = this.format(this.workingValue);
        // it's critical to have an event from the editor UI so we know when
        // a user has changed a value, vs some other form of alteration
        // for the same reason, we float our own changed event
        this.send('editor-value-changed');
      },
      format: function(value) {
        return value;
      }
    });
  </script>
</element>

<element name="tk-string-editor" extends="tk-abstract-editor">
  <template>
    <style>
      @host {
        * {
          display: inline-block;
          width: 95%;
        }
      }
      input {
        padding: 6px;
        margin-left: 0;
        width: 100%; 
        box-sizing: border-box;
        -webkit-user-select: all; 
        -moz-user-select: all;
        user-select: all;
      }
    </style>
    <input id="input" type="{{type}}" value="{{workingValue}}" on-change="commit">
  </template>
  <script>
    Toolkit.register(this, {
      type: "text",
      focus: function() {
        this.$.input.focus();
      }
    });
  </script>
</element>

<element name="tk-color-editor" extends="tk-string-editor">
  <script>
    Toolkit.register(this, {
      type: 'color',
      ready: function() {
        // TODO(sjmiles): box-sizing: border-box doesn't play nice with color inputs
        // TODO(sjmiles): is there a way to effect these styles via stylesheet?
        this.$.input.style.boxSizing = 'content-box';
        this.$.input.style.width = '95%';
        this.$.input.style.padding = '5px';
        // TODO(dfreedm): Workaround for http://crbug.com/234801, colorpicker
        // does not update swatch when in shadowdom because of focus issues
        this.$.input.tabindex = -1;
      },
      format: function(value) {
        return toHex(value);
      }
    });
    function toHex(color) {
      if (!color || color.substr(0, 1) === "#") {
        return color;
      }
      var nums = /(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/i.exec(color),
          r = parseInt(nums[2], 10).toString(16),
          g = parseInt(nums[3], 10).toString(16),
          b = parseInt(nums[4], 10).toString(16);
      return "#"+ (
          (r.length == 1 ? r + "0" : r) +
          (g.length == 1 ? g + "0" : g) +
          (b.length == 1 ? b + "0" : b)
      );
    }
  </script>
</element>

<element name="tk-boolean-editor" extends="tk-abstract-editor">
  <template>
    <input id="input" type="checkbox" checked="{{workingValue}}" on-change="inputChange">
  </template>
  <script>
    Toolkit.register(this, {
      inputChange: function(event) {
        this.workingValue = event.target.checked;
        this.commit();
      }
    });
  </script>
</element>

<element name="tk-select-editor" extends="tk-abstract-editor" attributes="options">
  <template>
    <style>
      @host {
        * {
          display: inline-block;
          width: 95%;
          position: relative;
        }
      }
      select {
        padding: 6px;
        margin-left: 0;
        margin-right: 0;
        width: 100%; 
        -webkit-user-select: all; 
        -moz-user-select: all;
        user-select: all;
      }
    </style>
    <select id="select" on-change="selectChange">
      <template repeat="{{options}}">
        <option>{{}}</option>
      </template>
    </select>
  </template>
  <script>
    Toolkit.register(this, {
      meta: null,
      metaChanged: function() {
        this.options = this.meta.options;
        // allow template to generate options before setting value
        this.asyncMethod(function() {
          this.$.select.value = this.workingValue;
        });
      },
      optionsChanged: function() {
        this.asyncMethod(function() {
          if (this.workingValue !== this.$.select.value) {
            this.selectChange();
          }
        });
      },
      selectChange: function() {
        this.workingValue = this.$.select.value;
        this.commit();
      },
      focus: function() {
        this.$.select.focus();
      }
    });
  </script>
</element>

<element name="tk-text-editor" extends="tk-abstract-editor">
  <template>
    <style>
      textarea {
        padding: 6px;
        margin: 0;
        width: 95%; 
        -webkit-user-select: all; 
        -moz-user-select: all;
        user-select: all;
        overflow: auto; 
        vertical-align: middle;
      }
    </style>
    <textarea id="input" on-change="commit" rows="10"></textarea>
  </template>
  <script>
    Toolkit.register(this, {
      workingValueChanged: function() {
        this.$.input.textContent = this.workingValue;
      }
    });
  </script>
</element>

<element name="tk-range-editor" extends="tk-abstract-editor" attributes="min max step defaultValue">
  <template>
    <style>
      @host {
        * {
          display: inline-block;
          width: 95%;
          position: relative;
        }
      }
      input {
        padding: 7px 6px 8px;
        margin: 0;
        width: 95%; 
        box-sizing: border-box;
        vertical-align: middle;
        -webkit-user-select: all; 
        -moz-user-select: all;
        user-select: all;
      }
    </style>
    <input id="input" type="range" value="{{workingValue}}" min="{{min}}" max="{{max}}" step="{{step}}" on-change="inputChange">
  </template>
  <script>
    Toolkit.register(this, {
      metaChanged: function() {
        if (this.meta) {
          this.min = this.meta.min;
          this.max = this.meta.max;
          this.step = this.meta.step;
          this.defaultValue = this.meta.defaultValue;
        }
      },
      valueChanged: function() {
        this.workingValue = this.value;
      },
      workingValueChanged: function() {
        if (this.workingValue === null || this.workingValue === '') {
          this.workingValue = this.defaultValue || this.min || 0;
        }
      }
    });
  </script>
</element>

<element name="tk-speech-editor" extends="tk-string-editor">
  <script>
    Toolkit.register(this, {
      ready: function() {
        this.$.input.setAttribute('x-webkit-speech');
      }
    });
  </script>
</element>

<element name="tk-compound-editor" extends="tk-abstract-editor">
  <template>
    <tk-string-editor style="width: 90px;"></tk-string-editor>
    <tk-select-editor style="width: 70px;" options="{{options}}"></tk-select-editor>
    <tk-range-editor style="width: 100px;"></tk-range-editor>
  </template>
  <script>
    Toolkit.register(this, {
      options: ['px', 'pt', '%', 'em', 'rem', '']
    });
  </script>
</element>

