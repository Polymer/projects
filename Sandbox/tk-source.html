<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<element name="tk-source" attributes="element">
  <template>
    <ajaxorg-ace id="editor" mode="html" theme="merbivore" readonly wrap></ajaxorg-ace>
  </template>
  <script>
    Toolkit.register(this, {
      publishPropertiesToAttributes: function() {
        var elt = this.element.firstElementChild;
        while (elt) {
          var p$ = elt.__published;
          if (p$) {
            Object.keys(p$).forEach(function(n) {
              var v = elt[n];
              if (v && (typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean')) {
                /*if (typeof v === 'boolean') {
                  v = n;
                }*/
                elt.setAttribute(n, v);
              } else {
                elt.removeAttribute(n);
              }
            });
          }
          elt = elt.nextElementSibling;
        }
      },
      update: function() {
        // force components to update before dumping source
        dirtyCheck();
        this.publishPropertiesToAttributes();
        var html = this.element.innerHTML;
        html = html
          .replace(/ style="[^"]*"/g, '')
          .replace(/( )?app-selected/g, '')
          ;
        this.$.editor.value = html_beautify(html);
      }
    });
  </script>
</element>
