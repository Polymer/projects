<!--
/*
 * Copyright 2013 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<link rel="component" href="../../../toolkit/components/g-icon.html"/>
<element name="pi-items-view" attributes="layout view items selected">
  <link rel="stylesheet" href="css/pi-layout.css" />
  <link rel="stylesheet" href="css/pi-items-view2.css" />
  <template>
    <div loaded="{{loaded}}" class="view {{layout}} {{view}}">
      <template iterate="viewitems">
        <div class="item">
          <div class="card" on-click="itemClick">
            <div class="image" style="background-image: url({{imgSrc}});" showing="{{imageShowing}}"></div>
            <div class="info">
              <div class="title">{{title}}
                <span class="unread-count">{{unread}}</span>
              </div>
              <div class="description">{{desc}}</div>
              <div class="source">
                <span class="source-icon" style="background-image: url({{sourceIcon}});"></span>
                <span class="source-title">{{source}}
                  <span class="source-time">{{since}}</span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </template>
      <div id="more" on-click="loadMore">
        <g-icon src="../images/refresh_lightreg.png"></g-icon>
          Load more articles
      </div>
    </div>
  </template>
  <script>
    Toolkit.register(this, {
      // public
      layout: 'grid',
      view: '',
      items: null,
      selected: null,
      loaded: true,
      // protected
      pageSize: 24,
      ready: function() {
        this.setAttribute('touch-action', 'scroll');
        this.updateMoreShowing();
      },
      itemsChanged: function() {
        if (this.pageSize > 0) {
          this.viewitems = this.items.slice(0, this.pageSize);
        }
        this.updateMoreShowing();
        this.scrollToTop();
      },
      scrollToTop: function() {
        webkitRequestAnimationFrame(function() {
          this.scrollTop = 0;
        }.bind(this));
      },
      updateMoreShowing: function() {
        this.$.more.style.display = 
            (this.viewitems && this.viewitems.length < this.items.length) ? null : 'none';
      },
      loadMore: function() {
        var l = this.viewitems.length;
        var more = this.items.slice(l, l + this.pageSize);
        more.forEach(function(m) {
          this.viewitems.push(m);
        }, this);
        this.updateMoreShowing();
      },
      itemClick: function(inEvent, inDetail, inSender) {
        this.selected = inSender.model;
        this.send('select', {item: inSender.model});
      }
    });
  </script>
</element>
