<!--
/*
 * Copyright 2012 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<element name="pi-feed-aggregator" attributes="feed count entries loading">
  <link rel="components" href="pi-gfeeds.html"/>
  <template>
    <pi-gfeeds id="gfeeds" feed="{{feedUrl}}" count="{{feedCount}}" loading="{{loading}}" entries={{feedEntries}}></pi-gfeeds>
  </template>
  <script>
    this.component({
      feedChanged: function() {
        if (this.feed) {
          this._entries = [];
          this.feeds = Array.isArray(this.feed) ? this.feed.slice(0) : [this.feed];
          this.feedCount = Math.ceil(this.count / this.feeds.length);
          this.fetch();
        } else {
          this.entries = null;
        }
      },
      fetch: function() {
        this.loading = true;
        if (this.feeds && this.feeds.length) {
          this.feedUrl = this.feeds.shift();
        } else {
          this.entries = this._entries.sort(this.dateSortDesc.bind(this));
          this.loading = false;
          this.feedUrl = null;
        }
      },
      feedEntriesChanged: function() {
        this._entries.push.apply(this._entries, this.feedEntries);
        this.fetch();
      },
      dateSortDesc: function(inEntry1, inEntry2) {
        var d1 = new Date(inEntry1.publishedDate);
        var d2 = new Date(inEntry2.publishedDate);
        if (d1 > d2) {
          return -1;
        } else if (d1 < d2) {
          return 1;
        }
        return 0;
      }
    });
  </script>
</element>
