<!--
/*
 * Copyright 2012 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<element name="pi-items-view" attributes="layout view">
  <link rel="stylesheet" href="css/pi-items-view.css" />
  <script src="../lib/web-animations.js"></script>
  <template>
    <div id="main" loaded="{{loaded}}" class="view {{layout}} {{view}}">
      <template iterate="boxes">
        <div class="box">
          <template iterate>
            <div class="inner {{box}}">
              <template iterate="items">
                <div class="pi-item" on-tap="itemClick">
                  <div class="image" style="background-image: url({{imgSrc}});" showing="{{imageShowing}}"></div>
                  <div class="title">{{title}}
                    <span class="unread-count">{{unread}}</span>
                  </div>
                  <div class="desc">{{desc}}
                    <span class="dummy-desc"><p>{{dummyText}}</p></span>
                  </div>
                  <div class="source">
                    <span class="source-icon" style="background-image: url({{sourceIcon}});"></span>
                    <span class="source-title">{{source}}
                      <span class="source-time">{{since}}</span>
                    </span>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </template>
      <div id="more" on-tap="loadMore">
        <g-icon src="../images/refresh_lightreg.png"></g-icon>
        Load more articles
      </div>
    </div>
  </template>
  <script>
    function toNumber(s) {
      return Number(s.substring(0, s.length - 2));
    }
  
    function calcMaxX() {
      var maxX = 0;
      for (var i = 0; i < cards.length; i++) {
        if (maxX < cards[i].offsetLeft) { maxX = cards[i].offsetLeft; }
      }
      return maxX;
    }
    
    this.component({
      publish: {
        loaded: true,
        pageSize: 6,
        items: null,
        selected: null
      },
      ready: function() {
        this.node.setAttribute('touch-action', 'scroll');
        this.updateMoreShowing();
      },
      loadedChanged: function() {
        if (this.loaded && this.layout == 'grid') {
          this.cascade();
        }
      },
      itemsChanged: function() {
        var b = [], l = this.items && this.items.length;
        for (var i=0; i < l; i += 4) {
          b.push([
            {box: 'one', items: this.items.slice(i, i+2)},
            {box: 'two', items: this.items.slice(i+2, i+4)}
          ]);
        }
        this.boxes = this.allBoxes = b;
        if (this.pageSize > 0) {
          this.boxes = this.allBoxes.slice(0, this.pageSize);
        }
        this.updateMoreShowing();
        this.scrollToTop();
      },
      scrollToTop: function() {
        webkitRequestAnimationFrame(function() {
          this.node.scrollTop = 0;
        }.bind(this));
      },
      updateMoreShowing: function() {
        this.$.more.style.display = (this.boxes && this.boxes.length < this.allBoxes.length) ? 
          null : 'none';
      },
      loadMore: function() {
        var l = this.boxes.length;
        var more = this.allBoxes.slice(l, l+this.pageSize);
        more.forEach(function(m) {
          this.boxes.push(m);
        }, this);
        this.updateMoreShowing();
      },
      itemClick: function(inEvent, inDetail, inSender) {
        this.selected = inSender.model;
        this.send('select', {item: inSender.model});
      },
      cascade: function() {
        var container = this.$.main;
        var cards = container.querySelectorAll('.pi-item');
        
        var width = toNumber(window.getComputedStyle(cards[0]).width);
        var height = toNumber(window.getComputedStyle(cards[0]).height);

        var containerWidth = toNumber(window.getComputedStyle(container).width);
        var containerHeight = document.documentElement.clientHeight;

        var scaledMiddleX = containerWidth / width / 2;
        var scaledMiddleY = containerHeight / height / 2;

        var parGroup = new ParGroup();

        for (var i = 0; i < cards.length; i++) {
          var y = cards[i].offsetTop / height;
          var x = cards[i].offsetLeft / width;
          var yDist = scaledMiddleY - y + 0.5;
          var xDist = scaledMiddleX - x + 0.5;
          var dist = Math.sqrt(yDist * yDist + xDist * xDist);
          var yTrans = yDist * 10 / dist;
          var xTrans = xDist * 10 / dist;
          var d = x + y;
          parGroup.add(
            new Animation(cards[i], {
              opacity: ["0", "1"],
              "-webkit-transform": ["translate(" + xTrans + "px, " + yTrans + "px) translateZ(0)", "translate(0px, 0px) translateZ(0)"]},
                {duration: 0.5, startDelay: 0.03 * d, fillMode: "backwards"}));
        }
        if (this.player) {
          this.player.cancel();
        }
        this.player = document.timeline.createPlayer(parGroup);

        if (this.nextStage) {
          this.nextStage.cancel();
        }
        this.nextStage = new ParGroup([], {timingFunction: "ease-out"});
        for (var i = 0; i < cards.length; i++) {
          if (i != 8) {
            this.nextStage.add(new Animation(cards[i], {opacity: "0"}, 0.5));
          }
        }
      }
    });
  </script>
</element>
