<!--
/*
 * Copyright 2013 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<link rel="import" href="../../toolkit/components/g-app.html">
<link rel="import" href="../../toolkit/components/g-ajax.html">
<link rel="import" href="../../toolkit/components/g-toolbar.html">
<link rel="import" href="../../toolkit/components/g-panels.html">
<link rel="import" href="../../toolkit/components/g-menu-item.html">
<link rel="import" href="../../toolkit/components/g-ribbon.html">
<link rel="import" href="../../toolkit/components/g-icon-button.html">
<link rel="import" href="../../pantry/Ace/Ace.html">
<element name="pg-app" extends="g-app">
  <template>
    <style>
      #menu {
        width: 300px;
      }

      #main {
        display: -webkit-flex;
        -webkit-flex-flow: column;
      }

      #content {
        display: -webkit-flex;
        position: relative;
        -webkit-flex: 1;
      }

      #ace {
        position: relative !important;
        width: 620px;
      }

      #outputContainer {
        -webkit-flex: 1;
        display: -webkit-flex;
        -webkit-flex-flow: column;
        border-left: 1px solid #ccc;
      }

      .titlebar {
        height: 40px;
        line-height: 40px;
        padding: 0 20px;
        background: #333;
        color: white;
      }

      .outputFrameContainer {
        -webkit-flex: 1;
        position: relative;
      }

      #output {
        background: white;
        border: 0;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .toolbar-button {
        -webkit-appearance: none;
        padding: 8px 14px 5px;
        background-color: #e6e6e6;
        background-repeat: no-repeat;
        background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#ffffff), color-stop(0.25, #ffffff), to(#e6e6e6));
        border: 1px solid #ccc;
        -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
        -webkit-border-radius: 3px;
        font-size: 14px;
        color: #333;
      }

      .toolbar-button:hover {
        background-position: 0 -15px;
      }

      .toolbar-button:active {
        -webkit-box-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
        color: #555;
      }

    </style>
    <g-panels id="panels" class="flex" index="1" transition="flow">
      <g-ribbon id="menu" label="Playground" valueattr="label" on-activate="toggle"
          selectedModel="{{selectedSample}}">
        <template repeat="{{sampleData}}">
          <g-menu-item src="src/images/sample.png" iconsize="32" label="{{name}}"></g-menu-item>
        </template>
      </g-ribbon>
      <div id="main">
        <g-toolbar>
          <g-icon-button src="src/images/menu.png" on-tap="toggle"></g-icon-button>
          <div>{{selectedSample.name}}</div>
          <button class="toolbar-button" on-click="run">Run</button>
        </g-toolbar>
        <div id="content">
          <ajaxorg-ace id="ace" theme="github" mode="html"></ajaxorg-ace>
          <div id="outputContainer">
            <div class="titlebar">Output</div>
            <div class="outputFrameContainer">
              <iframe id="output"></iframe>
            </div>
          </div>
        </div>
      </div>
    </g-panels>
    <g-ajax auto on-response="fileResponse" url="{{selectedSample.file}}"></ajax>
  </template>
  <script>
    Toolkit.register(this, {
      sampleData: [
        {name: 'NameTag', file: 'samples/nametag.html'},
        {name: 'Echo', file: 'samples/echo.html'},
        {name: 'Youtube Search', file: 'samples/youtubesearch.html'},
        {name: 'Youtube App', file: 'samples/yt-app.html'},
        {name: 'Pica', file: 'samples/pica.html'},
        {name: 'Panels', file: 'samples/panels.html'},
        {name: 'Cats', file: 'samples/cats.html'},
        {name: 'Playground', file: 'src/pg-app.html'}
      ],
      selectedSample: null,
      ready: function() {
        this.super();
        this.$.ace.editor.getSession().setTabSize(2);
        setTimeout(function() {
          this.$.menu.selected = this.sampleData[0].name;
        }.bind(this), 0);
      },
      toggle: function() {
        this.$.panels.toggleBetween('menu', 'main');
      },
      fileResponse: function(e, inDetail) {
        this.$.ace.value = inDetail.response;
        dirtyCheck();
        this.run();
      },
      run: function() {
        this.$.output.src = '';
        setTimeout(function() {
          var doc = this.$.output.contentDocument;
          var win = this.$.output.contentWindow;
          // put base href in head
          var h = '<base href="' + document.baseURI + '">\n';
          // fire fake load events in body
          var b = '<script>document.dispatchEvent(' +
            'new CustomEvent("DOMContentLoaded", {bubbles: true}));\n' +
            '</s' + 'cript>\n' +
            '<script>dispatchEvent(' +
            'new CustomEvent("load", {bubbles: true}));</s' + 'cript>';
          var s = this.makeOutputHTML(h, b);
          doc.write(s);
          // fire load after ready in case scripts are loaded and depend on this
          // e.g. WebAnimations
          var fn = function() {
            win.removeEventListener('WebComponentsReady', fn);
            win.dispatchEvent(new CustomEvent("load", {bubbles: true}));
          };
          win.addEventListener('WebComponentsReady', fn);
        }.bind(this), 0);
      },
      makeOutputHTML: function(head, body) {
       var html = '<!DOCTYPE html>\n';
       html += '<head>\n';
       html += head || '';
       // include base scripts
       html += '<script src="../../toolkit/toolkit.js"></s' + 'cript>\n';
       html += '</head>\n<body>\n';
       // include content
       html += this.calcUserHtml();
       html += body || '';
       html += '</body>\n</html>';
       return html;
      },
      calcUserHtml: function() {
        var html = this.$.ace.editor.getValue();
        return html;
      }
    });
  </script>
</element>

<pg-app></pg-app>